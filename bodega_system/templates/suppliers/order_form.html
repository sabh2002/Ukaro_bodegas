<!-- templates/suppliers/order_form.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}
{% if form.instance.pk %}Editar Orden{% else %}Nueva Orden de Compra{% endif %} - Sistema de Bodega
{% endblock %}

{% block extra_head %}
<style>
    .purchase-order-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: #f8fafc;
        min-height: 100vh;
    }

    .po-header {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
        border-left: 4px solid #059669;
    }

    .po-header-content {
        padding: 24px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 24px;
        align-items: center;
    }

    .po-title {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        color: #059669;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .po-meta {
        font-size: 14px;
        color: #6b7280;
        margin-top: 4px;
    }

    .po-actions {
        display: flex;
        gap: 12px;
    }

    .po-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        margin-bottom: 20px;
        border: 1px solid #e5e7eb;
    }

    .po-card-header {
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        padding: 16px 24px;
        border-radius: 12px 12px 0 0;
    }

    .po-card-title {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .po-card-content {
        padding: 24px;
    }

    /* Form inputs with professional styling */
    .po-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.2s ease;
        background: white;
    }

    .po-input:focus {
        outline: none;
        border-color: #059669;
        box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }

    .po-label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    /* Quick product addition toolbar */
    .product-toolbar {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border: 1px solid #a7f3d0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }

    .barcode-quick-add {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    .barcode-input {
        flex: 1;
        min-width: 200px;
        font-family: 'Courier New', monospace;
        font-size: 16px;
        padding: 8px 12px;
        border: 1px solid #059669;
        border-radius: 6px;
        background: white;
    }

    .barcode-input:focus {
        outline: none;
        border-color: #047857;
        box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }

    /* Professional product table */
    .po-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .po-table th {
        background: #f8fafc;
        padding: 12px;
        text-align: left;
        border-bottom: 2px solid #e5e7eb;
        font-weight: 600;
        color: #374151;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .po-table td {
        padding: 12px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
    }

    .po-table tr:hover {
        background: #f8fafc;
    }

    .po-table tr.new-product-row {
        background: #fef7ff;
        border-left: 3px solid #a855f7;
    }

    .po-table tr.new-product-row td {
        border-bottom: 1px solid #e879f9;
    }

    /* Product status badges */
    .product-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .product-badge.new {
        background: #fdf4ff;
        color: #a21caf;
        border: 1px solid #f0abfc;
    }

    .product-badge.existing {
        background: #ecfdf5;
        color: #059669;
        border: 1px solid #86efac;
    }

    /* Table inputs */
    .po-table-input {
        padding: 6px 10px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 13px;
        width: 100%;
        min-width: 70px;
    }

    .po-table-input:focus {
        outline: none;
        border-color: #059669;
        box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.1);
    }

    .po-table-input.narrow {
        min-width: 60px;
        text-align: center;
    }

    /* Status notifications */
    .po-notification {
        padding: 10px 16px;
        border-radius: 6px;
        margin: 8px 0;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .po-notification.success {
        background: #ecfdf5;
        color: #059669;
        border: 1px solid #86efac;
    }

    .po-notification.warning {
        background: #fffbeb;
        color: #d97706;
        border: 1px solid #fed7aa;
    }

    .po-notification.error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fca5a5;
    }

    /* Loading and buttons */
    .po-spinner {
        width: 14px;
        height: 14px;
        border: 2px solid currentColor;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .po-btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.2s ease;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
    }

    .po-btn.primary {
        background: #059669;
        color: white;
    }

    .po-btn.primary:hover {
        background: #047857;
    }

    .po-btn.secondary {
        background: white;
        color: #374151;
        border: 1px solid #d1d5db;
    }

    .po-btn.secondary:hover {
        background: #f9fafb;
    }

    .po-btn.danger {
        background: #dc2626;
        color: white;
        padding: 4px 8px;
    }

    .po-btn.danger:hover {
        background: #b91c1c;
    }

    .po-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Summary panel */
    .po-summary {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 1px solid #0ea5e9;
        border-radius: 8px;
        padding: 20px;
    }

    .po-summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .po-summary-row.total {
        border-top: 2px solid #0ea5e9;
        padding-top: 12px;
        margin-top: 12px;
        font-weight: 700;
        font-size: 16px;
        color: #0c4a6e;
    }

    /* Grid utilities */
    .po-grid {
        display: grid;
        gap: 16px;
    }

    .po-grid-2 {
        grid-template-columns: repeat(2, 1fr);
    }

    .po-grid-3 {
        grid-template-columns: repeat(3, 1fr);
    }

    .po-grid-4 {
        grid-template-columns: repeat(4, 1fr);
    }

    /* New product form */
    .new-product-form {
        background: #fdf4ff;
        border: 1px solid #f0abfc;
        border-radius: 8px;
        padding: 16px;
        margin-top: 8px;
    }

    .new-product-form .po-grid {
        gap: 12px;
    }

    /* Empty state */
    .po-empty {
        text-align: center;
        padding: 60px 24px;
        color: #6b7280;
    }

    .po-empty svg {
        width: 48px;
        height: 48px;
        margin: 0 auto 16px;
        opacity: 0.4;
    }

    /* Responsive design */
    @media (max-width: 1024px) {
        .po-header-content {
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .po-actions {
            justify-content: flex-start;
        }
    }

    @media (max-width: 768px) {
        .purchase-order-container {
            padding: 12px;
        }
        
        .po-card-content {
            padding: 16px;
        }
        
        .po-grid-2,
        .po-grid-3,
        .po-grid-4 {
            grid-template-columns: 1fr;
        }
        
        .barcode-quick-add {
            flex-direction: column;
            align-items: stretch;
        }
        
        .po-table {
            font-size: 12px;
        }
        
        .po-table td,
        .po-table th {
            padding: 8px 4px;
        }
        
        .po-table-input {
            min-width: 50px;
            padding: 4px 6px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="purchase-order-container">
    <!-- Header -->
    <div class="po-header">
        <div class="po-header-content">
            <div>
                <h1 class="po-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    {% if form.instance.pk %}Orden de Compra #{{ form.instance.id }}{% else %}Nueva Orden de Compra{% endif %}
                </h1>
                <div class="po-meta">
                    {% if form.instance.pk %}
                        Modifica los detalles de la orden existente
                    {% else %}
                        Registra productos y proveedores para crear una nueva orden
                    {% endif %}
                </div>
            </div>
            <div class="po-actions">
                <a href="{% url 'suppliers:order_list' %}" class="po-btn secondary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Volver
                </a>
            </div>
        </div>
    </div>

    <form method="post" action="{% url 'suppliers:order_create' %}" x-data="orderForm()" x-init="init()">
        {% csrf_token %}
        
        <!-- Order Information -->
        <div class="po-card">
            <div class="po-card-header">
                <h3 class="po-card-title">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Información de la Orden
                </h3>
            </div>
            <div class="po-card-content">
                <div class="po-grid po-grid-2">
                    <div>
                        <label class="po-label" for="{{ form.supplier.id_for_label }}">
                            Proveedor <span style="color: #dc2626;">*</span>
                        </label>
                        {{ form.supplier }}
                        {% if form.supplier.errors %}
                            <p style="color: #dc2626; font-size: 12px; margin-top: 4px;">{{ form.supplier.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="po-label" for="{{ form.status.id_for_label }}">
                            Estado de la Orden
                        </label>
                        {{ form.status }}
                        {% if form.status.errors %}
                            <p style="color: #dc2626; font-size: 12px; margin-top: 4px;">{{ form.status.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <div style="margin-top: 16px;">
                    <label class="po-label" for="{{ form.notes.id_for_label }}">
                        Términos y Condiciones / Notas
                    </label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <p style="color: #dc2626; font-size: 12px; margin-top: 4px;">{{ form.notes.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div class="po-card">
            <div class="po-card-header">
                <h3 class="po-card-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10"/>
                        </svg>
                        Productos de la Orden (<span x-text="products.length"></span>)
                    </div>
                    <div class="po-summary" style="padding: 8px 16px; margin: 0;">
                        <div style="font-size: 14px; font-weight: 600; color: #0c4a6e;">
                            Total: $<span x-text="totalUSD.toFixed(2)"></span> USD
                        </div>
                        <div style="font-size: 12px; color: #0369a1;">
                            Bs <span x-text="(totalUSD * exchangeRate).toFixed(2)"></span>
                        </div>
                    </div>
                </h3>
            </div>
            <div class="po-card-content">
                <!-- Quick Add Toolbar -->
                <div class="product-toolbar">
                    <div class="barcode-quick-add">
                        <div style="display: flex; align-items: center; gap: 8px; min-width: 0;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h2M4 4h5m3 0h6m-9 0h2"/>
                            </svg>
                            <span style="font-size: 13px; font-weight: 600; color: #047857; white-space: nowrap;">Escanear código:</span>
                        </div>
                        <input 
                            type="text" 
                            x-model="barcodeInput"
                            @keydown.enter.prevent="scanBarcode"
                            class="barcode-input"
                            placeholder="Código de barras..."
                            autocomplete="off">
                        <button 
                            type="button"
                            @click="scanBarcode"
                            :disabled="scanning || !barcodeInput.trim()"
                            class="po-btn primary">
                            <div x-show="scanning" class="po-spinner"></div>
                            <svg x-show="!scanning" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <span x-text="scanning ? 'Buscando...' : 'Buscar'"></span>
                        </button>
                        <button 
                            type="button"
                            @click="openNewProductModal"
                            class="po-btn secondary">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Producto Nuevo
                        </button>
                    </div>
                    
                    <!-- Status Message -->
                    <div x-show="statusMessage.text" class="po-notification" :class="statusMessage.type">
                        <svg x-show="statusMessage.type === 'success'" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <svg x-show="statusMessage.type === 'warning'" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.083 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <svg x-show="statusMessage.type === 'error'" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span x-text="statusMessage.text"></span>
                    </div>
                </div>

                <!-- Empty State -->
                <div x-show="products.length === 0" class="po-empty">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10"/>
                    </svg>
                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No hay productos en esta orden</h4>
                    <p style="font-size: 14px;">Use el código de barras o agregue productos manualmente para comenzar</p>
                </div>
                
                <!-- Products Table -->
                <div x-show="products.length > 0" style="overflow-x: auto;">
                    <table class="po-table">
                        <thead>
                            <tr>
                                <th style="min-width: 200px;">Producto</th>
                                <th style="min-width: 100px;">SKU/Código</th>
                                <th style="text-align: center; width: 80px;">Cant.</th>
                                <th style="text-align: center; width: 100px;">Precio Unit. USD</th>
                                <th style="text-align: right; width: 100px;">Subtotal</th>
                                <th style="text-align: center; width: 60px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(product, index) in products" :key="product.tempId">
                                <tr :class="product.isNew ? 'new-product-row' : ''">
                                    <td>
                                        <div style="display: flex; flex-direction: column; gap: 6px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span class="product-badge" :class="product.isNew ? 'new' : 'existing'">
                                                    <span x-text="product.isNew ? 'Nuevo' : 'Existente'"></span>
                                                </span>
                                            </div>
                                            <input 
                                                x-show="product.isNew"
                                                type="text" 
                                                x-model="product.name"
                                                class="po-table-input"
                                                placeholder="Nombre del producto"
                                                style="font-weight: 600; font-size: 14px;">
                                            <div 
                                                x-show="!product.isNew"
                                                style="font-weight: 600; font-size: 14px; color: #374151;"
                                                x-text="product.name"></div>
                                        </div>
                                    </td>
                                    <td>
                                        <code style="font-size: 12px; color: #6b7280; background: #f3f4f6; padding: 2px 6px; border-radius: 4px;"
                                              x-text="product.barcode || '-'"></code>
                                    </td>
                                    <td style="text-align: center;">
                                        <input 
                                            type="number" 
                                            x-model.number="product.quantity"
                                            @input="updateTotals"
                                            min="0.001" 
                                            step="0.001"
                                            class="po-table-input narrow">
                                    </td>
                                    <td style="text-align: center;">
                                        <input 
                                            type="number" 
                                            x-model.number="product.purchasePrice"
                                            @input="updateTotals"
                                            min="0" 
                                            step="0.01"
                                            class="po-table-input narrow">
                                    </td>
                                    <td style="text-align: right; font-weight: 600; color: #059669;">
                                        $<span x-text="(product.quantity * product.purchasePrice).toFixed(2)"></span>
                                    </td>
                                    <td style="text-align: center;">
                                        <button 
                                            type="button"
                                            @click="removeProduct(index)"
                                            class="po-btn danger"
                                            title="Eliminar producto">
                                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                
                                <!-- New Product Details Form -->
                                <tr x-show="product.isNew" class="new-product-row">
                                    <td colspan="6">
                                        <div class="new-product-form">
                                            <div style="font-size: 12px; font-weight: 600; color: #a21caf; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">
                                                📦 Detalles del Nuevo Producto
                                            </div>
                                            <div class="po-grid po-grid-2">
                                                <div>
                                                    <label class="po-label" style="font-size: 11px;">Código de Barras *</label>
                                                    <input 
                                                        type="text" 
                                                        x-model="product.barcode"
                                                        class="po-table-input"
                                                        placeholder="Código único"
                                                        >
                                                </div>
                                                <div>
                                                    <label class="po-label" style="font-size: 11px;">Categoría *</label>
                                                    <select x-model="product.category" class="po-table-input">
                                                        <option value="">Seleccionar...</option>
                                                        {% for category in categories %}
                                                            <option value="{{ category.id }}">{{ category.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="po-grid po-grid-3" style="margin-top: 12px;">
                                                <div>
                                                    <label class="po-label" style="font-size: 11px;">Unidad *</label>
                                                    <select x-model="product.unitType" class="po-table-input">
                                                        {% for choice in unit_choices %}
                                                            <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="po-label" style="font-size: 11px;">Precio Venta USD *</label>
                                                    <input 
                                                        type="number" 
                                                        x-model.number="product.sellingPrice"
                                                        min="0" 
                                                        step="0.01"
                                                        class="po-table-input"
                                                        placeholder="0.00"
                                                        >
                                                </div>
                                                <div>
                                                    <label class="po-label" style="font-size: 11px;">Stock Mínimo</label>
                                                    <input 
                                                        type="number" 
                                                        x-model.number="product.minStock"
                                                        min="0" 
                                                        step="1"
                                                        class="po-table-input"
                                                        value="5">
                                                </div>
                                            </div>
                                            <div class="po-grid po-grid-1" style="margin-top: 12px;">
                                                <div>
                                                    <label class="po-label" style="font-size: 11px;">Descripción (Opcional)</label>
                                                    <input 
                                                        type="text" 
                                                        x-model="product.description"
                                                        class="po-table-input"
                                                        placeholder="Descripción del producto">
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Hidden Form Fields for Django Formset -->
        {{ formset.management_form }}
        
        <!-- Dynamic formset generation for Django -->
        <div id="real-formset-fields" style="display: none;"></div>
        
        <script>
        document.addEventListener('alpine:initialized', () => {
            const managementForm = document.querySelector('input[name="form-TOTAL_FORMS"]');
            const app = Alpine.$data(document.querySelector('[x-data="orderForm()"]'));
            const formsetContainer = document.getElementById('real-formset-fields');
            
            // Function to generate real HTML inputs for Django formset
            function generateFormsetFields(products) {
                console.log('Generating formset fields for:', products);
                
                // Clear existing fields
                formsetContainer.innerHTML = '';
                
                // Update total forms count
                if (managementForm) {
                    managementForm.value = products.length;
                    console.log('Updated TOTAL_FORMS to:', products.length);
                }
                
                // Generate fields for each product
                products.forEach((product, index) => {
                    const fieldContainer = document.createElement('div');
                    fieldContainer.className = 'formset-item';
                    
                    // Validate required fields for new products
                    if (product.isNew) {
                        const requiredFields = ['name', 'category', 'sellingPrice'];
                        const missingFields = requiredFields.filter(field => !product[field]);
                        
                        if (missingFields.length > 0) {
                            console.error(`Missing required fields for product ${index}:`, missingFields);
                        }
                    }
                    
                    // Sanitize values to prevent HTML injection and ensure valid data
                    const sanitize = (value) => {
                        if (value === null || value === undefined) return '';
                        return String(value).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    };
                    
                    // Main formset fields - USAR NOMBRES CORRECTOS
                    fieldContainer.innerHTML = `
                        <input type="hidden" name="items-${index}-id" value="">
                        <input type="hidden" name="items-${index}-product" value="${sanitize(product.productId)}">
                        <input type="hidden" name="items-${index}-quantity" value="${sanitize(product.quantity || 1)}">
                        <input type="hidden" name="items-${index}-price_usd" value="${sanitize(product.purchasePrice || 0)}">
                        <input type="hidden" name="items-${index}-is_new_product" value="${product.isNew ? 'on' : ''}">
                        ${product.isNew ? `
                            <input type="hidden" name="items-${index}-new_product_name" value="${sanitize(product.name)}">
                            <input type="hidden" name="items-${index}-new_product_barcode" value="${sanitize(product.barcode)}">
                            <input type="hidden" name="items-${index}-new_product_category" value="${sanitize(product.category)}">
                            <input type="hidden" name="items-${index}-new_product_unit_type" value="${sanitize(product.unitType || 'unit')}">
                            <input type="hidden" name="items-${index}-new_product_selling_price_usd" value="${sanitize(product.sellingPrice || 0)}">
                            <input type="hidden" name="items-${index}-new_product_min_stock" value="${sanitize(product.minStock || 5)}">
                            <input type="hidden" name="items-${index}-new_product_description" value="${sanitize(product.description || '')}">
                        ` : ''}
                    `;
                    
                    formsetContainer.appendChild(fieldContainer);
                });
                
                console.log('Generated formset fields HTML:', formsetContainer.innerHTML);
            }
            
            // Update formset fields whenever products array changes
            app.$watch('products', (newProducts) => {
                console.log('🔄 Products array changed, regenerating formset fields...');
                console.log('New products array:', newProducts);
                generateFormsetFields(newProducts);
            });
            
            // Generate fields on form submit
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', (e) => {
                    console.log('=== FORM SUBMISSION ===');
                    console.log('Products array:', app.products);
                    
                    // Validate products before submission
                    const invalidProducts = app.products.filter((product, index) => {
                        if (product.isNew) {
                            const missing = [];
                            if (!product.name) missing.push('name');
                            if (!product.barcode) missing.push('barcode');
                            if (!product.category) missing.push('category');
                            if (!product.sellingPrice || product.sellingPrice <= 0) missing.push('sellingPrice');
                            if (!product.quantity || product.quantity <= 0) missing.push('quantity');
                            if (!product.purchasePrice || product.purchasePrice <= 0) missing.push('purchasePrice');
                            
                            if (missing.length > 0) {
                                console.error(`Product ${index} missing fields:`, missing);
                                return true;
                            }
                        }
                        return false;
                    });
                    
                    if (invalidProducts.length > 0) {
                        e.preventDefault();
                        alert('Por favor complete todos los campos requeridos para los productos nuevos.');
                        return false;
                    }
                    
                    generateFormsetFields(app.products);
                    
                    // Debug: log all form data
                    setTimeout(() => {
                        const formData = new FormData(form);
                        console.log('=== FINAL FORM DATA SUBMITTED ===');
                        console.log('Total products in array:', app.products.length);
                        app.products.forEach((prod, idx) => {
                            console.log(`Product ${idx}:`, {
                                name: prod.name,
                                isNew: prod.isNew,
                                barcode: prod.barcode,
                                productId: prod.productId
                            });
                        });
                        
                        console.log('Form fields being sent:');
                        for (let [key, value] of formData.entries()) {
                            if (key.startsWith('items-') || key === 'supplier' || key === 'status' || key.includes('TOTAL_FORMS')) {
                                console.log(key + ': ' + value);
                            }
                        }
                        console.log('=== END FORM DATA ===');
                    }, 10);
                });
            }
        });
        </script>

        <!-- Order Summary & Actions -->
        <div class="po-card">
            <div class="po-card-content">
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 24px; align-items: end;">
                    <div class="po-summary">
                        <h4 style="font-size: 14px; font-weight: 600; color: #0c4a6e; margin-bottom: 8px;">Resumen de la Orden</h4>
                        <div class="po-summary-row">
                            <span>Productos:</span>
                            <span x-text="products.length"></span>
                        </div>
                        <div class="po-summary-row">
                            <span>Subtotal USD:</span>
                            <span>$<span x-text="totalUSD.toFixed(2)"></span></span>
                        </div>
                        <div class="po-summary-row">
                            <span>Subtotal Bs:</span>
                            <span>Bs <span x-text="(totalUSD * exchangeRate).toFixed(2)"></span></span>
                        </div>
                        <div class="po-summary-row total">
                            <span>TOTAL:</span>
                            <span>$<span x-text="totalUSD.toFixed(2)"></span> USD</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <a href="{% url 'suppliers:order_list' %}" class="po-btn secondary">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            Cancelar
                        </a>
                        <button 
                            type="submit"
                            :disabled="products.length === 0 || !validateProducts()"
                            class="po-btn primary" style="padding: 12px 24px;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            {% if form.instance.pk %}Actualizar Orden de Compra{% else %}Crear Orden de Compra{% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Producto Nuevo -->
        <div x-show="showNewProductModal" 
             x-transition:enter="transition ease-out duration-300" 
             x-transition:enter-start="opacity-0 transform scale-90" 
             x-transition:enter-end="opacity-100 transform scale-100" 
             x-transition:leave="transition ease-in duration-200" 
             x-transition:leave-start="opacity-100 transform scale-100" 
             x-transition:leave-end="opacity-0 transform scale-90"
             class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
             @click.self="closeNewProductModal">
            
            <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <!-- Header -->
                <div class="flex items-center justify-between p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="inline mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Registrar Producto Nuevo
                    </h3>
                    <button @click="closeNewProductModal" class="text-gray-400 hover:text-gray-600">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6m0 0l6 6m-6-6v12"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Body -->
                <div class="p-6">
                    <div>
                        <!-- Información Básica -->
                        <div class="mb-6">
                            <h4 class="font-medium text-gray-900 mb-4">📦 Información Básica</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Nombre del Producto <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" x-model="newProductForm.name"
                                           @keydown.enter.prevent=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Ejemplo: Pasta Mary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Código de Barras <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" x-model="newProductForm.barcode"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Código único del producto">
                                </div>
                            </div>
                        </div>

                        <!-- Categoría y Unidad -->
                        <div class="mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Categoría <span class="text-red-500">*</span>
                                    </label>
                                    <select x-model="newProductForm.category"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar categoría...</option>
                                        {% for category in categories %}
                                            <option value="{{ category.id }}">{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Tipo de Unidad <span class="text-red-500">*</span>
                                    </label>
                                    <select x-model="newProductForm.unitType"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        {% for choice in unit_choices %}
                                            <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Precios -->
                        <div class="mb-6">
                            <h4 class="font-medium text-gray-900 mb-4">💰 Información de Precios</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Precio de Compra USD <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" x-model.number="newProductForm.purchasePrice"
                                           min="0" step="0.01"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Precio de Venta USD <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" x-model.number="newProductForm.sellingPrice"
                                           min="0" step="0.01"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Cantidad para la Orden <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" x-model.number="newProductForm.quantity"
                                           min="0.01" step="0.01"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="1.00">
                                </div>
                            </div>
                        </div>

                        <!-- Inventario -->
                        <div class="mb-6">
                            <h4 class="font-medium text-gray-900 mb-4">📦 Información de Inventario</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Stock Mínimo
                                    </label>
                                    <input type="number" x-model.number="newProductForm.minStock"
                                           min="0" step="1" value="5"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Descripción (Opcional)
                                    </label>
                                    <input type="text" x-model="newProductForm.description"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Descripción del producto">
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="flex justify-end space-x-3">
                            <button type="button" @click="closeNewProductModal" 
                                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                                Cancelar
                            </button>
                            <button type="button" @click="saveNewProduct"
                                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">
                                Agregar a la Orden
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('orderForm', () => ({
        // State
        products: [],
        barcodeInput: '',
        scanning: false,
        statusMessage: { type: '', text: '' },
        exchangeRate: 7.0,
        showNewProductModal: false,
        newProductForm: {
            name: '',
            barcode: '',
            category: '',
            unitType: 'unit',
            purchasePrice: 0,
            sellingPrice: 0,
            quantity: 1,
            minStock: 5,
            description: ''
        },
        
        // Computed
        get totalUSD() {
            return this.products.reduce((sum, product) => 
                sum + (product.quantity * product.purchasePrice), 0);
        },
        
        // Methods
        async scanBarcode() {
            const code = this.barcodeInput.trim();
            if (!code) {
                this.showStatus('error', 'Ingrese un código de barras');
                return;
            }
            
            console.log('Escaneando código:', code);
            this.scanning = true;
            this.statusMessage = { type: '', text: '' };
            
            try {
                const response = await fetch(`/suppliers/api/product-lookup/${encodeURIComponent(code)}/`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // Producto no encontrado - agregar como nuevo
                        this.addNewProduct(code);
                        this.showStatus('warning', `Producto nuevo agregado con código: ${code}`);
                    } else {
                        throw new Error('Error de conexión. Intente nuevamente.');
                    }
                } else {
                    const productData = await response.json();
                    console.log('Producto encontrado:', productData);
                    
                    // Verificar si ya está en la lista
                    const existingIndex = this.products.findIndex(p => p.barcode === code);
                    
                    if (existingIndex !== -1) {
                        // Incrementar cantidad
                        this.products[existingIndex].quantity += 1;
                        this.showStatus('success', `Cantidad incrementada: "${productData.name}"`);
                    } else {
                        // Agregar producto existente
                        this.addExistingProduct(productData);
                        this.showStatus('success', `Producto agregado: "${productData.name}"`);
                    }
                }
                
                this.barcodeInput = '';
                this.focusBarcodeInput();
                
            } catch (error) {
                console.error('Error scanning:', error);
                this.showStatus('error', error.message || 'Error de conexión. Intente nuevamente.');
            } finally {
                this.scanning = false;
            }
        },
        
        addExistingProduct(productData) {
            this.products.push({
                tempId: Date.now() + Math.random(),
                id: '',
                productId: productData.id,
                name: productData.name,
                barcode: productData.barcode,
                quantity: 1,
                purchasePrice: parseFloat(productData.purchase_price_usd || 0),
                category: productData.category,
                unitType: productData.unit_type,
                sellingPrice: parseFloat(productData.selling_price_usd || 0),
                minStock: parseFloat(productData.min_stock || 5),
                description: productData.description || '',
                brand: '',
                location: '',
                isNew: false
            });
        },
        
        addNewProduct(barcode) {
            this.products.push({
                tempId: Date.now() + Math.random(),
                id: '',
                productId: '',
                name: '',
                barcode: barcode,
                quantity: 1,
                purchasePrice: 0,
                category: '',
                unitType: 'unit',
                sellingPrice: 0,
                minStock: 5,
                description: '',
                brand: '',
                location: '',
                isNew: true
            });
            
            // Auto-focus on the product name field and show the new product fields
            this.$nextTick(() => {
                const nameInputs = document.querySelectorAll('input[x-model="product.name"]');
                if (nameInputs.length > 0) {
                    nameInputs[nameInputs.length - 1].focus();
                    nameInputs[nameInputs.length - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        },
        
        openNewProductModal() {
            // Reset form
            this.newProductForm = {
                name: '',
                barcode: '',
                category: '',
                unitType: 'unit',
                purchasePrice: 0,
                sellingPrice: 0,
                quantity: 1,
                minStock: 5,
                description: ''
            };
            this.showNewProductModal = true;
            
            // Focus on first field after modal opens
            this.$nextTick(() => {
                const firstInput = document.querySelector('input[x-model="newProductForm.name"]');
                if (firstInput) firstInput.focus();
            });
        },
        
        closeNewProductModal() {
            this.showNewProductModal = false;
        },
        
        saveNewProduct() {
            // Validate required fields
            if (!this.newProductForm.name || !this.newProductForm.barcode || 
                !this.newProductForm.category || !this.newProductForm.purchasePrice || 
                !this.newProductForm.sellingPrice || !this.newProductForm.quantity) {
                alert('Por favor complete todos los campos requeridos.');
                return;
            }
            
            // Check if barcode already exists
            const existingProduct = this.products.find(p => p.barcode === this.newProductForm.barcode);
            if (existingProduct) {
                alert('Ya existe un producto con este código de barras en la orden.');
                return;
            }
            
            // Add product to order
            const newProduct = {
                tempId: Date.now() + Math.random(),
                id: '',
                productId: '',
                name: this.newProductForm.name,
                barcode: this.newProductForm.barcode,
                quantity: this.newProductForm.quantity,
                purchasePrice: this.newProductForm.purchasePrice,
                category: this.newProductForm.category,
                unitType: this.newProductForm.unitType,
                sellingPrice: this.newProductForm.sellingPrice,
                minStock: this.newProductForm.minStock,
                description: this.newProductForm.description,
                isNew: true
            };
            
            console.log('🆕 Adding new product to order:', newProduct);
            this.products.push(newProduct);
            console.log('📦 Total products after add:', this.products.length);
            console.log('📦 Products array:', this.products);
            
            // Close modal and show success message
            this.closeNewProductModal();
            this.showStatus('success', `Producto "${this.newProductForm.name}" agregado a la orden.`);
        },
        
        removeProduct(index) {
            this.products.splice(index, 1);
        },
        
        updateTotals() {
            // Trigger reactivity
            this.$nextTick();
        },
        
        validateProducts() {
            if (this.products.length === 0) {
                return false;
            }
            
            // Check if all products have valid data
            return this.products.every((product, index) => {
                // Basic validation for all products
                if (!product.quantity || product.quantity <= 0) {
                    return false;
                }
                if (!product.purchasePrice || product.purchasePrice <= 0) {
                    return false;
                }
                
                // If it's a new product, validate required fields
                if (product.isNew) {
                    return product.name && 
                           product.barcode && 
                           product.category && 
                           product.sellingPrice && 
                           product.sellingPrice > 0;
                }
                
                // For existing products, productId should be valid OR we should have a barcode at minimum
                return (product.productId && product.productId > 0) || (product.barcode && product.name);
            });
        },
        
        showStatus(type, text) {
            this.statusMessage = { type, text };
            setTimeout(() => {
                this.statusMessage = { type: '', text: '' };
            }, 5000);
        },
        
        focusBarcodeInput() {
            setTimeout(() => {
                const input = document.querySelector('input[x-model="barcodeInput"]');
                if (input) input.focus();
            }, 100);
        },
        
        init() {
            this.exchangeRate = {{ current_exchange_rate.bs_to_usd|default:7.0 }};
            this.focusBarcodeInput();
            
            console.log('Order form initialized with exchange rate:', this.exchangeRate);
        }
    }));
});
</script>
{% endblock %}