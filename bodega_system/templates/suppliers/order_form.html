<!-- templates/suppliers/order_form.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ title }} - Sistema de Bodega{% endblock %}

{% block extra_head %}
<style>
    .form-row-error {
        border-color: #F56565;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">{{ title }}</h1>
        <a href="{% url 'suppliers:order_list' %}" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md inline-flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
            </svg>
            Volver
        </a>
    </div>
    
    <form method="post" class="space-y-6" id="orderForm">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
        <div class="bg-red-50 text-red-800 p-4 rounded-md mb-6">
            {{ form.non_field_errors }}
        </div>
        {% endif %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Información básica -->
            <div class="bg-gray-50 p-4 rounded-md space-y-4">
                <h2 class="text-lg font-medium text-gray-700 border-b pb-2">Información Básica</h2>
                
                <div>
                    <label for="{{ form.supplier.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Proveedor</label>
                    {{ form.supplier }}
                    {% if form.supplier.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.supplier.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                    {{ form.status }}
                    {% if form.status.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.status.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.notes.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div class="flex items-center mt-4">
                    {{ form.paid }}
                    <label for="{{ form.paid.id_for_label }}" class="ml-2 block text-sm text-gray-900">
                        Pagado
                    </label>
                    {% if form.paid.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.paid.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Resumen -->
            <div class="bg-gray-50 p-4 rounded-md">
                <h2 class="text-lg font-medium text-gray-700 border-b pb-2 mb-4">Resumen</h2>
                
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Total Ítems:</span>
                        <span class="text-sm font-medium" id="itemCount">0</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Total Productos:</span>
                        <span class="text-sm font-medium" id="productCount">0</span>
                    </div>
                    
                    <div class="flex justify-between items-center border-t border-gray-200 pt-2 mt-2">
                        <span class="text-base font-medium text-gray-700">Total:</span>
                        <span class="text-base font-bold text-indigo-700" id="totalAmount">Bs 0.00</span>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md">
                        {% if order %}Actualizar{% else %}Guardar{% endif %} Orden
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Ítems de la orden -->
        <div class="bg-gray-50 p-4 rounded-md">
            <h2 class="text-lg font-medium text-gray-700 border-b pb-2 mb-4">Productos</h2>
            
            {{ formset.management_form }}
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="itemsTable">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Producto
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Precio Unitario (Bs)
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Cantidad
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Subtotal
                            </th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Eliminar
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for form in formset.forms %}
                        <tr class="formset-row {% if form.errors %}form-row-error{% endif %}">
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                            
                            <td class="px-6 py-4">
                                {{ form.product }}
                                {% if form.product.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.product.errors.0 }}</p>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex justify-end">
                                    {{ form.price_bs }}
                                </div>
                                {% if form.price_bs.errors %}
                                <p class="mt-1 text-sm text-red-600 text-right">{{ form.price_bs.errors.0 }}</p>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex justify-end">
                                    {{ form.quantity }}
                                </div>
                                {% if form.quantity.errors %}
                                <p class="mt-1 text-sm text-red-600 text-right">{{ form.quantity.errors.0 }}</p>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right">
                                <span class="subtotal">Bs 0.00</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                                <button type="button" class="delete-row text-red-600 hover:text-red-900">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4">
                <button type="button" id="addRow" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Agregar Producto
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const formset = document.getElementById('orderForm');
        const addRowBtn = document.getElementById('addRow');
        const itemsTable = document.getElementById('itemsTable').querySelector('tbody');
        const totalCounter = document.getElementById('totalAmount');
        const itemCounter = document.getElementById('itemCount');
        const productCounter = document.getElementById('productCount');
        
        const prefix = '{{ formset.prefix }}';
        let formCount = parseInt(document.getElementById('id_{{ formset.prefix }}-TOTAL_FORMS').value);
        
        // Actualizar contadores y totales
        function updateCounters() {
            let total = 0;
            let itemCount = 0;
            let productSet = new Set();
            const rows = itemsTable.querySelectorAll('tr:not(.empty-form)');
            
            rows.forEach(row => {
                const deleteCheckbox = row.querySelector('input[type="checkbox"]');
                const isDeleted = deleteCheckbox && deleteCheckbox.checked;
                
                if (!isDeleted) {
                    const priceInput = row.querySelector('input[name$="-price_bs"]');
                    const quantityInput = row.querySelector('input[name$="-quantity"]');
                    const productSelect = row.querySelector('select[name$="-product"]');
                    
                    if (priceInput && quantityInput && productSelect.value) {
                        const price = parseFloat(priceInput.value) || 0;
                        const quantity = parseInt(quantityInput.value) || 0;
                        const subtotal = price * quantity;
                        total += subtotal;
                        itemCount++;
                        
                        // Actualizar subtotal
                        const subtotalElement = row.querySelector('.subtotal');
                        if (subtotalElement) {
                            subtotalElement.textContent = `Bs ${subtotal.toFixed(2)}`;
                        }
                        
                        // Agregar producto al conjunto
                        if (productSelect.value) {
                            productSet.add(productSelect.value);
                        }
                    }
                }
            });
            
            totalCounter.textContent = `Bs ${total.toFixed(2)}`;
            itemCounter.textContent = itemCount;
            productCounter.textContent = productSet.size;
        }
        
        // Agregar fila
        addRowBtn.addEventListener('click', function() {
            // Clonar la primera fila
            const emptyForm = document.querySelector('.formset-row:last-child').cloneNode(true);
            
            // Actualizar IDs y names
            updateElementAttr(emptyForm, 'id');
            updateElementAttr(emptyForm, 'name');
            
            // Limpiar valores
            emptyForm.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
                input.value = '';
            });
            
            emptyForm.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Reiniciar subtotal
            emptyForm.querySelector('.subtotal').textContent = 'Bs 0.00';
            
            // Agregar al formulario
            itemsTable.appendChild(emptyForm);
            
            // Actualizar contador del formset
            formCount++;
            document.getElementById('id_{{ formset.prefix }}-TOTAL_FORMS').value = formCount;
            
            // Agregar event listeners
            addRowEventListeners(emptyForm);
            
            // Actualizar contadores
            updateCounters();
        });
        
        // Función para actualizar atributos
        function updateElementAttr(element, attrName) {
            element.querySelectorAll(`[${attrName}^="${prefix}"]`).forEach(el => {
                const attr = el.getAttribute(attrName);
                if (attr) {
                    const newAttr = attr.replace(
                        new RegExp(`${prefix}-\\d+`), 
                        `${prefix}-${formCount}`
                    );
                    el.setAttribute(attrName, newAttr);
                }
            });
        }
        
        // Función para agregar event listeners a una fila
        function addRowEventListeners(row) {
            // Evento para eliminar fila
            const deleteBtn = row.querySelector('.delete-row');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    const deleteCheckbox = row.querySelector('input[type="checkbox"]');
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                        row.style.display = 'none';
                    } else {
                        row.remove();
                        formCount--;
                        document.getElementById('id_{{ formset.prefix }}-TOTAL_FORMS').value = formCount;
                    }
                    updateCounters();
                });
            }
            
            // Eventos para calcular subtotal
            const priceInput = row.querySelector('input[name$="-price_bs"]');
            const quantityInput = row.querySelector('input[name$="-quantity"]');
            
            if (priceInput) {
                priceInput.addEventListener('input', updateCounters);
            }
            
            if (quantityInput) {
                quantityInput.addEventListener('input', updateCounters);
            }
        }
        
        // Agregar event listeners a todas las filas existentes
        document.querySelectorAll('.formset-row').forEach(row => {
            addRowEventListeners(row);
        });
        
        // Actualizar contadores iniciales
        updateCounters();
    });
</script>
{% endblock %}