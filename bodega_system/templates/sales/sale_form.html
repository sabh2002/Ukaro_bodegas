{% extends 'base/base.html' %}

{% block title %}Nueva Venta - Sistema de Bodega{% endblock %}

{% block extra_head %}
<style>
    .product-row:hover {
        background-color: #f3f4f6;
    }
    .unit-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.625rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        background-color: #dbeafe;
        color: #1d4ed8;
    }
    .weight-badge {
        background-color: #fef3c7;
        color: #d97706;
    }
    .quantity-input {
        width: 100px;
        text-align: center;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        transition: border-color 0.15s ease-in-out;
    }
    .quantity-input:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 1px #4f46e5;
    }
    .quantity-input:invalid {
        border-color: #ef4444;
    }
    .debug-info {
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        padding: 0.5rem;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: #374151;
    }
</style>
{% endblock %}

{% block content %}
<!-- CSRF Token para Alpine.js -->
{% csrf_token %}

<!-- DATOS JSON PARA JAVASCRIPT -->
{{ data_for_js|json_script:"data-for-js" }}

<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h1 class="text-2xl font-bold text-gray-800 mb-4">Nueva Venta</h1>
    
    <div x-data="salesApp" x-init="init()">
        <!-- Debug Panel (solo en modo desarrollo) -->
        <div x-show="showDebug" class="debug-info mb-4">
            <h4 class="font-medium mb-2">Debug Info:</h4>
            <div>Último producto escaneado: <span x-text="lastScannedProduct"></span></div>
            <div>Items actuales: <span x-text="items.length"></span></div>
            <div>Total calculado: <span x-text="total"></span></div>
            <div>Código actual: <span x-text="barcode"></span></div>
            <div>Notas actuales: <span x-text="notes"></span></div>
            <div>Exchange rate: <span x-text="exchangeRate"></span></div>
        </div>

        <!-- Panel de búsqueda de productos -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="md:col-span-2">
                <label for="barcode" class="block text-sm font-medium text-gray-700 mb-1">Código de Barras</label>
                <div class="relative rounded-md shadow-sm">
                    <input 
                        type="text" 
                        id="barcode" 
                        x-model="barcode"
                        @keydown.enter.prevent="scanBarcode"
                        @input="lastScannedProduct = $event.target.value"
                        class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-4 pr-12 sm:text-sm border-gray-300 rounded-md"
                        placeholder="Escanee o ingrese el código de barras"
                        autocomplete="off"
                        autofocus>
                    <div class="absolute inset-y-0 right-0 flex items-center">
                        <button 
                            @click="scanBarcode"
                            type="button"
                            class="h-full py-0 px-3 border-transparent bg-transparent text-gray-500 sm:text-sm rounded-r-md hover:text-indigo-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button 
                    @click="showDebug = !showDebug"
                    type="button"
                    class="mt-1 text-xs text-gray-500 hover:text-gray-700">
                    Toggle Debug
                </button>
            </div>
            
            <div>
                <label for="customer_search" class="block text-sm font-medium text-gray-700 mb-1">Cliente (opcional)</label>
                <div class="relative rounded-md shadow-sm">
                    <input 
                        type="text" 
                        id="customer_search" 
                        x-model="customerSearch"
                        @input="searchCustomers"
                        @keydown.enter.prevent="selectFirstCustomer"
                        @keydown.down.prevent="navigateCustomer(1)"
                        @keydown.up.prevent="navigateCustomer(-1)"
                        @keydown.escape="clearCustomerSearch"
                        class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-4 pr-12 sm:text-sm border-gray-300 rounded-md"
                        placeholder="Buscar cliente..."
                        autocomplete="off">
                    <div class="absolute inset-y-0 right-0 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                
                <!-- Lista de clientes encontrados -->
                <div x-show="customerResults.length > 0" class="absolute z-10 w-full bg-white border border-gray-200 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto">
                    <template x-for="(customer, index) in customerResults" :key="customer.id">
                        <div 
                            @click="selectCustomer(customer)"
                            :class="{'bg-indigo-50': index === customerSelectedIndex}"
                            class="px-3 py-2 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0">
                            <div class="font-medium text-sm" x-text="customer.name"></div>
                            <div class="text-xs text-gray-500" x-text="customer.phone || 'Sin teléfono'"></div>
                        </div>
                    </template>
                </div>
                
                <!-- Cliente seleccionado -->
                <div x-show="selectedCustomer" class="mt-2 flex items-center justify-between bg-green-50 p-2 rounded-md">
                    <div>
                        <div class="text-sm font-medium text-green-800" x-text="selectedCustomer?.name"></div>
                        <div class="text-xs text-green-600" x-text="selectedCustomer?.phone"></div>
                    </div>
                    <button @click="clearSelectedCustomer" type="button" class="text-green-600 hover:text-green-800">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de productos en la venta -->
        <div class="bg-white border border-gray-200 rounded-md overflow-hidden mb-6">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PRODUCTO</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">PRECIO</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">CANTIDAD</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">SUBTOTAL</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ACCIONES</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="(item, index) in items" :key="item.id + '_' + index">
                        <tr class="product-row">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900" x-text="item.name"></div>
                                        <div class="text-xs text-gray-500" x-text="'Código: ' + item.barcode"></div>
                                        <span :class="item.is_weight_based ? 'weight-badge' : 'unit-badge'" x-text="item.unit_display"></span>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <div class="text-sm text-gray-900">Bs <span x-text="parseFloat(item.price).toFixed(2)"></span></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <input 
                                    type="number" 
                                    x-model.number="item.quantity"
                                    @input="updateItemSubtotal(index)"
                                    :min="item.is_weight_based ? '0.01' : '1'"
                                    :step="item.is_weight_based ? '0.01' : '1'"
                                    class="quantity-input">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <div class="text-sm font-medium text-gray-900">Bs <span x-text="parseFloat(item.subtotal).toFixed(2)"></span></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <button 
                                    @click="removeItem(index)"
                                    type="button"
                                    class="text-red-600 hover:text-red-900">
                                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    </template>
                    
                    <!-- Fila cuando no hay items -->
                    <tr x-show="items.length === 0">
                        <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                            Escanee un código de barras para agregar productos.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Resumen y totales -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 bg-white rounded-md border border-gray-200 p-4">
                <div class="mb-4">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notas (opcional)</label>
                    <textarea 
                        id="notes" 
                        x-model="notes"
                        rows="2"
                        class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                        placeholder="Agregar notas a la venta..."></textarea>
                </div>
                
                <div class="flex flex-col md:flex-row items-center md:justify-between space-y-2 md:space-y-0">
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            id="is_credit" 
                            x-model="isCredit"
                            :disabled="!selectedCustomer"
                            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="is_credit" class="ml-2 block text-sm text-gray-900">
                            Venta a crédito
                        </label>
                        <span x-show="!selectedCustomer" class="ml-2 text-xs text-gray-500">(Requiere cliente)</span>
                    </div>
                    <div>
                        <button 
                            @click="resetSale"
                            type="button"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Reiniciar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Panel de resumen -->
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg p-6 text-white">
                <h3 class="text-lg font-medium mb-4">Resumen</h3>
                <div class="space-y-2 mb-6">
                    <div class="flex justify-between">
                        <span>Subtotal:</span>
                        <span>Bs <span x-text="parseFloat(subtotal).toFixed(2)"></span></span>
                    </div>
                    <div class="flex justify-between text-lg font-bold border-t border-white/20 pt-2">
                        <span>Total:</span>
                        <span>Bs <span x-text="parseFloat(total).toFixed(2)"></span></span>
                    </div>
                    <div class="text-sm opacity-90" x-show="exchangeRate > 0">
                        USD $<span x-text="parseFloat(total / exchangeRate).toFixed(2)"></span>
                    </div>
                </div>
                
                <button 
                    @click="completeSale"
                    :disabled="items.length === 0"
                    :class="{'opacity-50 cursor-not-allowed': items.length === 0}"
                    class="w-full bg-white text-indigo-600 border border-transparent rounded-md shadow-sm py-3 px-4 text-base font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <div class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Completar Venta</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Modal para cantidad (productos que requieren peso) -->
        <div x-show="showQuantityModal" 
             x-cloak
             class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Especificar Cantidad</h3>
                    <div x-show="pendingProduct">
                        <p class="text-sm text-gray-600 mb-4">
                            Producto: <span x-text="pendingProduct?.name"></span>
                        </p>
                        <p class="text-sm text-gray-600 mb-4" x-show="pendingProduct?.is_weight_based">
                            Este producto se vende por peso (kg)
                        </p>
                        <input 
                            type="number" 
                            x-model="quantityInput"
                            :step="pendingProduct?.is_weight_based ? '0.01' : '1'"
                            :min="pendingProduct?.is_weight_based ? '0.01' : '1'"
                            placeholder="Ingrese la cantidad"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                            @keydown.enter="confirmQuantity"
                            x-ref="quantityModalInput">
                    </div>
                    <div class="flex justify-center space-x-3 mt-6">
                        <button 
                            @click="confirmQuantity"
                            class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                            Confirmar
                        </button>
                        <button 
                            @click="closeQuantityModal"
                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    
    // OBTENER DATOS DESDE DJANGO DE FORMA SEGURA
    function getSafeData() {
        try {
            const dataElement = document.getElementById('data-for-js');
            return dataElement ? JSON.parse(dataElement.textContent) : {};
        } catch (e) {
            console.warn('Error parsing data from Django:', e);
            return {};
        }
    }
    
    document.addEventListener('alpine:init', () => {
        Alpine.data('salesApp', () => ({
            // Estados principales - INICIALIZAR SIEMPRE COMO STRINGS VACÍOS
            items: [],
            barcode: '',
            customerSearch: '',
            customerResults: [],
            customerSelectedIndex: -1,
            selectedCustomer: null,
            isCredit: false,
            notes: '',
            exchangeRate: 1, // VALOR POR DEFECTO SEGURO
            
            // Variables para el modal de cantidad
            showQuantityModal: false,
            pendingProduct: null,
            quantityInput: '',
            
            // Debug
            showDebug: false,
            lastScannedProduct: '',
            
            // Computed properties
            get subtotal() {
                return this.items.reduce((sum, item) => sum + parseFloat(item.subtotal || 0), 0);
            },
            
            get total() {
                return this.subtotal;
            },
            
            // Métodos principales
            async scanBarcode() {
                const code = this.barcode ? this.barcode.trim() : '';
                if (!code) {
                    this.focusBarcodeInput();
                    return;
                }
                
                console.log('Escaneando código:', code);
                this.lastScannedProduct = code;
                
                try {
                    const response = await fetch(`/api/products/barcode/${encodeURIComponent(code)}/`);
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            alert('Producto no encontrado');
                        } else {
                            const errorData = await response.json();
                            alert(errorData.error || 'Error al buscar el producto');
                        }
                        this.barcode = '';
                        this.focusBarcodeInput();
                        return;
                    }
                    
                    const product = await response.json();
                    console.log('Producto encontrado:', product);
                    
                    // Verificar stock
                    if (product.stock <= 0) {
                        alert(`El producto "${product.name}" no tiene stock disponible`);
                        this.barcode = '';
                        this.focusBarcodeInput();
                        return;
                    }
                    
                    // Verificar si ya está en la lista
                    const existingIndex = this.items.findIndex(item => item.id === product.id);
                    
                    if (existingIndex !== -1) {
                        // Producto ya existe, incrementar cantidad
                        const currentQuantity = this.items[existingIndex].quantity;
                        const newQuantity = product.is_weight_based ? currentQuantity + 1 : currentQuantity + 1;
                        
                        if (newQuantity > product.stock) {
                            alert(`Stock insuficiente. Disponible: ${product.stock}`);
                            this.barcode = '';
                            this.focusBarcodeInput();
                            return;
                        }
                        
                        this.items[existingIndex].quantity = newQuantity;
                        this.updateItemSubtotal(existingIndex);
                    } else {
                        // Producto nuevo
                        if (product.is_weight_based) {
                            // Mostrar modal para productos por peso
                            this.pendingProduct = product;
                            this.quantityInput = '1';
                            this.showQuantityModal = true;
                            setTimeout(() => {
                                this.$refs.quantityModalInput?.focus();
                            }, 100);
                        } else {
                            // Agregar directamente productos por unidad
                            this.addProductToSale(product, 1);
                        }
                    }
                    
                    this.barcode = '';
                    if (!this.showQuantityModal) {
                        this.focusBarcodeInput();
                    }
                    
                } catch (error) {
                    console.error('Error al escanear código:', error);
                    alert('Error de conexión. Intente nuevamente.');
                    this.barcode = '';
                    this.focusBarcodeInput();
                }
            },
            
            addProductToSale(product, quantity) {
                const item = {
                    id: product.id,
                    name: product.name,
                    barcode: product.barcode,
                    price: product.selling_price_bs,
                    quantity: quantity,
                    subtotal: product.selling_price_bs * quantity,
                    stock: product.stock,
                    unit_display: product.unit_display,
                    is_weight_based: product.is_weight_based
                };
                
                this.items.push(item);
                console.log('Producto agregado:', item);
            },
            
            updateItemSubtotal(index) {
                if (this.items[index]) {
                    const item = this.items[index];
                    item.subtotal = parseFloat(item.price) * parseFloat(item.quantity);
                }
            },
            
            removeItem(index) {
                this.items.splice(index, 1);
            },
            
            // Modal de cantidad
            confirmQuantity() {
                const quantity = parseFloat(this.quantityInput);
                
                if (!quantity || quantity <= 0) {
                    alert('Ingrese una cantidad válida');
                    return;
                }
                
                if (quantity > this.pendingProduct.stock) {
                    alert(`Stock insuficiente. Disponible: ${this.pendingProduct.stock}`);
                    return;
                }
                
                this.addProductToSale(this.pendingProduct, quantity);
                this.closeQuantityModal();
            },
            
            closeQuantityModal() {
                this.showQuantityModal = false;
                this.pendingProduct = null;
                this.quantityInput = '';
                this.focusBarcodeInput();
            },
            
            // Gestión de clientes
            async searchCustomers() {
                const query = this.customerSearch ? this.customerSearch.trim() : '';
                if (query.length < 2) {
                    this.customerResults = [];
                    return;
                }
                
                try {
                    const response = await fetch(`/api/customers/search/?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    this.customerResults = data.customers || [];
                    this.customerSelectedIndex = -1;
                } catch (error) {
                    console.error('Error al buscar clientes:', error);
                    this.customerResults = [];
                }
            },
            
            navigateCustomer(direction) {
                if (this.customerResults.length === 0) return;
                
                this.customerSelectedIndex += direction;
                
                if (this.customerSelectedIndex < 0) {
                    this.customerSelectedIndex = this.customerResults.length - 1;
                } else if (this.customerSelectedIndex >= this.customerResults.length) {
                    this.customerSelectedIndex = 0;
                }
            },
            
            selectFirstCustomer() {
                if (this.customerResults.length > 0) {
                    this.selectCustomer(this.customerResults[0]);
                }
            },
            
            selectCustomer(customer) {
                this.selectedCustomer = customer;
                this.customerSearch = '';
                this.customerResults = [];
                this.customerSelectedIndex = -1;
            },
            
            clearSelectedCustomer() {
                this.selectedCustomer = null;
                this.isCredit = false;
            },
            
            clearCustomerSearch() {
                this.customerSearch = '';
                this.customerResults = [];
                this.customerSelectedIndex = -1;
            },
            
            // Completar venta
            async completeSale() {
                if (this.items.length === 0) {
                    alert('Agregue al menos un producto a la venta');
                    return;
                }
                
                if (this.isCredit && !this.selectedCustomer) {
                    alert('Para venta a crédito debe seleccionar un cliente');
                    return;
                }
                
                const saleData = {
                    items: this.items.map(item => ({
                        product_id: item.id,
                        quantity: item.quantity,
                        price_bs: item.price
                    })),
                    customer_id: this.selectedCustomer ? this.selectedCustomer.id : null,
                    is_credit: this.isCredit,
                    notes: this.notes || '',
                    total_bs: this.total
                };
                
                console.log('=== DATOS DE VENTA COMPLETOS ===');
                console.log(JSON.stringify(saleData, null, 2));
                console.log('=== FIN DATOS DE VENTA ===');
                
                try {
                    const response = await fetch('{% url "sales:create_sale_api" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify(saleData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Error del servidor:', errorData);
                        throw new Error(errorData.error || 'Error al procesar la venta');
                    }
                    
                    const result = await response.json();
                    console.log('Respuesta del servidor:', result);
                    
                    // Abrir recibo en nueva ventana
                    if (result.id) {
                        window.open(`/sales/${result.id}/receipt/`, '_blank');
                        this.resetSale();
                        
                        // Enfocar el input para seguir escaneando
                        this.focusBarcodeInput();
                    }
                } catch (error) {
                    console.error('Error completo:', error);
                    alert(error.message || 'Error al procesar la venta');
                }
            },
            
            resetSale() {
                this.items = [];
                this.barcode = '';
                this.selectedCustomer = null;
                this.isCredit = false;
                this.notes = '';
                this.closeQuantityModal();
                this.clearCustomerSearch();
            },
            
            focusBarcodeInput() {
                setTimeout(() => {
                    const input = document.getElementById('barcode');
                    if (input) {
                        input.focus();
                    }
                }, 100);
            },
            
            init() {
                // OBTENER DATOS DE DJANGO DE FORMA SEGURA
                const safeData = getSafeData();
                
                // Configurar exchange rate de forma segura
                if (safeData.exchangeRate && typeof safeData.exchangeRate === 'number' && safeData.exchangeRate > 0) {
                    this.exchangeRate = safeData.exchangeRate;
                } else {
                    this.exchangeRate = 1; // Valor por defecto
                    console.warn('Exchange rate no disponible, usando valor por defecto');
                }
                
                // Enfocar el input al cargar la página
                this.focusBarcodeInput();
                
                console.log('SalesApp inicializado correctamente');
                console.log('Exchange rate:', this.exchangeRate);
            }
        }));
    });
</script>
{% endblock %}