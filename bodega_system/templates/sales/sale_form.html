
{% extends 'base/base.html' %}

{% block title %}Nueva Venta - Sistema de Bodega{% endblock %}

{% block extra_head %}
<style>
    .product-row:hover {
        background-color: #f3f4f6;
    }
    .unit-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.625rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        background-color: #dbeafe;
        color: #1d4ed8;
    }
    .weight-badge {
        background-color: #fef3c7;
        color: #d97706;
    }
    .quantity-input {
        width: 100px;
        text-align: center;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        transition: border-color 0.15s ease-in-out;
    }
    .quantity-input:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 1px #4f46e5;
    }
    .quantity-input:invalid {
        border-color: #ef4444;
    }
    .debug-info {
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        padding: 0.5rem;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: #374151;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h1 class="text-2xl font-bold text-gray-800 mb-4">Nueva Venta</h1>
    
    <div x-data="salesApp">
        <!-- Debug Panel (solo en modo desarrollo) -->
        <div x-show="showDebug" class="debug-info mb-4">
            <h4 class="font-medium mb-2">Debug Info:</h4>
            <div>Último producto escaneado: <span x-text="lastScannedProduct"></span></div>
            <div>Items actuales: <span x-text="items.length"></span></div>
            <div>Total calculado: <span x-text="total"></span></div>
        </div>

        <!-- Panel de búsqueda de productos -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="md:col-span-2">
                <label for="barcode" class="block text-sm font-medium text-gray-700 mb-1">Código de Barras</label>
                <div class="relative rounded-md shadow-sm">
                    <input 
                        type="text" 
                        id="barcode" 
                        x-model="barcode"
                        @keydown.enter.prevent="scanBarcode"
                        class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-4 pr-12 sm:text-sm border-gray-300 rounded-md"
                        placeholder="Escanee o ingrese el código de barras"
                        autocomplete="off">
                    <div class="absolute inset-y-0 right-0 flex items-center">
                        <button 
                            @click="scanBarcode"
                            class="h-full py-0 px-3 border-transparent bg-transparent text-gray-500 sm:text-sm rounded-r-md hover:text-indigo-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button 
                    @click="showDebug = !showDebug"
                    class="mt-1 text-xs text-gray-500 hover:text-gray-700">
                    Toggle Debug
                </button>
            </div>
            
            <div>
                <label for="customer" class="block text-sm font-medium text-gray-700 mb-1">Cliente (opcional)</label>
                <div class="relative rounded-md shadow-sm">
                    <input 
                        type="text" 
                        id="customer_search" 
                        x-model="customerSearch"
                        @input="searchCustomers"
                        @keydown.enter.prevent="selectFirstCustomer"
                        @keydown.down.prevent="navigateCustomer(1)"
                        @keydown.up.prevent="navigateCustomer(-1)"
                        class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-4 pr-12 sm:text-sm border-gray-300 rounded-md"
                        placeholder="Buscar cliente...">
                </div>
                
                <!-- Resultados de búsqueda de clientes -->
                <div 
                    x-show="customerResults.length > 0" 
                    x-cloak
                    class="absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto max-h-60 focus:outline-none sm:text-sm">
                    <template x-for="(customer, index) in customerResults" :key="customer.id">
                        <div 
                            @click="selectCustomer(customer)"
                            :class="{'bg-indigo-100': customerSelectedIndex === index}"
                            class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-indigo-50">
                            <div class="flex items-center">
                                <span class="font-normal ml-3 block truncate" x-text="customer.name"></span>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Cliente seleccionado -->
                <div x-show="selectedCustomer" x-cloak class="mt-2 p-2 bg-indigo-50 rounded-md">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-sm font-medium text-indigo-700" x-text="selectedCustomer.name"></span>
                            <span x-show="selectedCustomer.phone" class="text-xs text-gray-500 block" x-text="selectedCustomer.phone"></span>
                        </div>
                        <button @click="clearCustomer" class="text-indigo-600 hover:text-indigo-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para ingresar cantidades variables (peso/volumen) -->
        <div x-show="showQuantityModal" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Ingresar Cantidad</h3>
                    <div class="mt-4">
                        <div class="text-sm text-gray-600 mb-2">
                            Producto: <span class="font-medium" x-text="pendingProduct?.name"></span>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <span class="font-medium text-orange-600" x-text="getQuantityLabel(pendingProduct?.unit_code)"></span>
                        </div>
                        <div class="text-xs text-gray-500 mb-4">
                            Stock disponible: <span x-text="pendingProduct?.stock"></span> <span x-text="pendingProduct?.unit_type"></span>
                        </div>
                        <input 
                            type="text" 
                            inputmode="decimal"
                            x-model="quantityInput"
                            x-ref="quantityInputField"
                            @keydown.enter.prevent="confirmQuantity"
                            @keydown.escape.prevent="cancelQuantity"
                            class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md text-center"
                            :placeholder="getQuantityPlaceholder(pendingProduct?.unit_code)">
                        <div class="text-xs text-gray-500 mt-1">
                            Use punto (.) para decimales
                        </div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button 
                            @click="confirmQuantity"
                            class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 mr-2">
                            Agregar
                        </button>
                        <button 
                            @click="cancelQuantity"
                            class="mt-3 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Lista de productos en la venta -->
        <div class="bg-gray-50 rounded-md border border-gray-200 overflow-hidden mb-6">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Producto
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Precio
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Cantidad
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Subtotal
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Acciones
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="(item, index) in items" :key="index">
                        <tr class="product-row">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900" x-text="item.name"></div>
                                <div class="text-xs text-gray-500" x-text="item.barcode"></div>
                                <div class="mt-1">
                                    <span 
                                        :class="item.is_weight_based ? 'weight-badge' : 'unit-badge'"
                                        class="unit-badge" 
                                        x-text="item.unit_type">
                                    </span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-500">
                                <span x-text="formatCurrency(item.price_bs)"></span>
                                <div class="text-xs text-gray-400">
                                    por <span x-text="item.unit_type"></span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <div class="flex items-center justify-end space-x-2">
                                    <button 
                                        @click="decrementQuantity(index)" 
                                        class="bg-gray-200 text-gray-700 rounded-full w-6 h-6 flex items-center justify-center hover:bg-gray-300">
                                        -
                                    </button>
                                    <div class="relative">
                                        <input 
                                            type="text" 
                                            inputmode="decimal"
                                            x-model="item.quantity"
                                            @focus="startEditing(index); $event.target.select()"
                                            @blur="finishEditing(index)"
                                            @keydown.enter.prevent="finishEditing(index); $event.target.blur()"
                                            @keydown.escape.prevent="cancelEditing(index); $event.target.blur()"
                                            class="quantity-input"
                                            :title="`Cantidad ${item.unit_type}. Use punto para decimales (ej: 0.25)`">
                                    </div>
                                    <button 
                                        @click="incrementQuantity(index)" 
                                        class="bg-indigo-100 text-indigo-700 rounded-full w-6 h-6 flex items-center justify-center hover:bg-indigo-200">
                                        +
                                    </button>
                                </div>
                                <div class="text-xs text-gray-400 mt-1">
                                    <span x-text="item.unit_type"></span>
                                    <span x-show="item.is_weight_based" class="text-orange-500"> • Use 0.25 para decimales</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-gray-900">
                                <span x-text="formatCurrency(item.price_bs * parseFloat(item.quantity || 0))"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button 
                                    @click="removeItem(index)" 
                                    class="text-red-600 hover:text-red-800">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="items.length === 0">
                        <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                            No hay productos en la venta. Escanee un código de barras para agregar productos.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Resumen y totales -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 bg-white rounded-md border border-gray-200 p-4">
                <div class="mb-4">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notas (opcional)</label>
                    <textarea 
                        id="notes" 
                        x-model="notes"
                        rows="2"
                        class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                        placeholder="Agregar notas a la venta..."></textarea>
                </div>
                
                <div class="flex flex-col md:flex-row items-center md:justify-between space-y-2 md:space-y-0">
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            id="is_credit" 
                            x-model="isCredit"
                            :disabled="!selectedCustomer"
                            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="is_credit" class="ml-2 block text-sm text-gray-900">
                            Venta a crédito
                        </label>
                    </div>
                    <div>
                        <button 
                            @click="resetSale"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Reiniciar
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="bg-indigo-50 rounded-md border border-indigo-100 p-4">
                <h3 class="text-lg font-medium text-indigo-800 mb-4">Resumen</h3>
                
                <div class="space-y-2 mb-6">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Subtotal:</span>
                        <span class="text-sm font-medium" x-text="formatCurrency(total)"></span>
                    </div>
                    
                    <div class="flex justify-between border-t border-indigo-200 pt-2">
                        <span class="text-base font-medium text-gray-800">Total:</span>
                        <span class="text-base font-bold text-indigo-800" x-text="formatCurrency(total)"></span>
                    </div>
                    
                    <div x-show="exchangeRate" class="flex justify-between text-xs text-gray-500">
                        <span>Equivalente en USD:</span>
                        <span x-text="formatCurrency(total / exchangeRate, '$')"></span>
                    </div>
                </div>
                
                <button 
                    @click="completeSale"
                    :disabled="items.length === 0"
                    :class="{'opacity-50 cursor-not-allowed': items.length === 0}"
                    class="w-full bg-indigo-600 border border-transparent rounded-md shadow-sm py-3 px-4 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <div class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Completar Venta</span>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    
    document.addEventListener('alpine:init', () => {
        Alpine.data('salesApp', () => ({
            items: [],
            barcode: '',
            customerSearch: '',
            customerResults: [],
            customerSelectedIndex: -1,
            selectedCustomer: null,
            isCredit: false,
            notes: '',
            exchangeRate: {{ latest_exchange_rate.bs_to_usd|default:0 }},
            
            // Variables para el modal de cantidad
            showQuantityModal: false,
            pendingProduct: null,
            quantityInput: '',
            
            // Debug
            showDebug: false,
            lastScannedProduct: '',
            
            async scanBarcode() {
                if (!this.barcode.trim()) return;
                
                try {
                    const response = await fetch(`/api/products/barcode/${this.barcode}/`);
                    
                    if (!response.ok) {
                        alert('Producto no encontrado');
                        return;
                    }
                    
                    const product = await response.json();
                    this.lastScannedProduct = `${product.name} (${product.unit_type})`;
                    console.log('Producto encontrado:', product);
                    
                    // Solo mostrar modal para productos por peso/volumen
                    if (product.is_weight_based || product.unit_code === 'liter' || product.unit_code === 'ml') {
                        this.pendingProduct = product;
                        this.quantityInput = '';
                        this.showQuantityModal = true;
                        this.$nextTick(() => {
                            this.$refs.quantityInputField?.focus();
                        });
                    } else {
                        // Para productos por unidad, agregar directamente
                        this.addItem(product, 1);
                    }
                    
                    this.barcode = '';
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al buscar el producto');
                }
            },
            
            confirmQuantity() {
                if (!this.quantityInput || this.quantityInput.trim() === '') {
                    alert('Ingrese una cantidad válida');
                    return;
                }
                
                // Limpiar y convertir cantidad
                let quantity = this.quantityInput.replace(',', '.').trim();
                let numQuantity = parseFloat(quantity);
                
                if (isNaN(numQuantity) || numQuantity <= 0) {
                    alert('Ingrese una cantidad válida mayor que 0');
                    return;
                }
                
                // Verificar stock disponible
                if (numQuantity > this.pendingProduct.stock) {
                    alert(`Stock insuficiente. Disponible: ${this.pendingProduct.stock} ${this.pendingProduct.unit_type}`);
                    return;
                }
                
                this.addItem(this.pendingProduct, numQuantity);
                this.closeQuantityModal();
                
                setTimeout(() => {
                    document.getElementById('barcode').focus();
                }, 100);
            },
            
            cancelQuantity() {
                this.closeQuantityModal();
                setTimeout(() => {
                    document.getElementById('barcode').focus();
                }, 100);
            },
            
            closeQuantityModal() {
                this.showQuantityModal = false;
                this.pendingProduct = null;
                this.quantityInput = '';
            },
            
            addItem(product, quantity = 1) {
                const existingItem = this.items.find(item => item.id === product.id);
                
                if (existingItem) {
                    existingItem.quantity = (parseFloat(existingItem.quantity) + parseFloat(quantity)).toString();
                } else {
                    this.items.push({
                        id: product.id,
                        name: product.name,
                        barcode: product.barcode,
                        price_bs: product.selling_price_bs,
                        quantity: quantity.toString(),
                        unit_type: product.unit_type,
                        unit_code: product.unit_code,
                        is_weight_based: product.is_weight_based,
                        stock: product.stock
                    });
                }
            },
            
            removeItem(index) {
                this.items.splice(index, 1);
            },
            
            incrementQuantity(index) {
                const item = this.items[index];
                const increment = this.getIncrement(item.unit_code);
                const currentQuantity = parseFloat(item.quantity) || 0;
                const newQuantity = currentQuantity + increment;
                item.quantity = newQuantity.toString();
                this.validateQuantity(index);
            },
            
            decrementQuantity(index) {
                const item = this.items[index];
                const decrement = this.getIncrement(item.unit_code);
                const currentQuantity = parseFloat(item.quantity) || 0;
                const newQuantity = currentQuantity - decrement;
                
                const minQuantity = item.is_weight_based ? 0.001 : 1;
                if (newQuantity < minQuantity) {
                    this.removeItem(index);
                } else {
                    item.quantity = newQuantity.toString();
                    this.validateQuantity(index);
                }
            },
            
            getIncrement(unitCode) {
                const increments = {
                    'kg': 0.25,      // 250 gramos
                    'gram': 100,     // 100 gramos  
                    'liter': 0.25,   // 250 ml
                    'ml': 100,       // 100 ml
                    'unit': 1        // 1 unidad
                };
                return increments[unitCode] || 1;
            },
            
            validateQuantity(index) {
                const item = this.items[index];
                let quantityStr = (item.quantity || '').toString().trim();
                
                // Si está vacío o es solo "0" sin punto decimal, establecer cantidad mínima
                if (quantityStr === '' || quantityStr === '0') {
                    if (item.is_weight_based) {
                        item.quantity = '0.001'; // Cantidad mínima para productos por peso
                    } else {
                        item.quantity = '1'; // Cantidad mínima para productos por unidad
                    }
                    return;
                }
                
                // Si termina en punto, permitirlo temporalmente (ej: "2.")
                if (quantityStr.endsWith('.')) {
                    return;
                }
                
                let quantity = parseFloat(quantityStr.replace(',', '.'));
                
                // Si no es un número válido, restaurar a cantidad mínima
                if (isNaN(quantity)) {
                    item.quantity = item.is_weight_based ? '0.001' : '1';
                    return;
                }
                
                // Si es menor que la cantidad mínima, establecer cantidad mínima
                const minQuantity = item.is_weight_based ? 0.001 : 1;
                if (quantity < minQuantity) {
                    item.quantity = minQuantity.toString();
                    return;
                }
                
                // Validar stock disponible
                if (quantity > item.stock) {
                    alert(`Stock insuficiente para ${item.name}. Disponible: ${item.stock} ${item.unit_type}`);
                    item.quantity = item.stock.toString();
                    return;
                }
                
                // Normalizar el valor (quitar comas, formatear decimales)
                item.quantity = quantity.toString();
            },
            
            // Eliminar la función validateAndUpdateQuantity ya que no la usamos más
            
            async searchCustomers() {
                if (!this.customerSearch) {
                    this.customerResults = [];
                    return;
                }
                
                try {
                    const response = await fetch(`/api/customers/search/?q=${encodeURIComponent(this.customerSearch)}`);
                    const data = await response.json();
                    
                    this.customerResults = data.customers;
                    this.customerSelectedIndex = this.customerResults.length > 0 ? 0 : -1;
                } catch (error) {
                    console.error('Error:', error);
                }
            },
            
            selectCustomer(customer) {
                this.selectedCustomer = customer;
                this.customerSearch = '';
                this.customerResults = [];
            },
            
            clearCustomer() {
                this.selectedCustomer = null;
                this.isCredit = false;
            },
            
            navigateCustomer(direction) {
                if (this.customerResults.length === 0) return;
                
                const newIndex = this.customerSelectedIndex + direction;
                if (newIndex >= 0 && newIndex < this.customerResults.length) {
                    this.customerSelectedIndex = newIndex;
                }
            },
            
            selectFirstCustomer() {
                if (this.customerResults.length > 0 && this.customerSelectedIndex >= 0) {
                    this.selectCustomer(this.customerResults[this.customerSelectedIndex]);
                }
            },
            
            getQuantityLabel(unitCode) {
                const labels = {
                    'kg': 'Se vende por kilogramo',
                    'gram': 'Se vende por gramo', 
                    'liter': 'Se vende por litro',
                    'ml': 'Se vende por mililitro'
                };
                return labels[unitCode] || 'Se vende por cantidad variable';
            },
            
            getQuantityPlaceholder(unitCode) {
                const placeholders = {
                    'kg': 'Ej: 2.5 (dos kilos y medio)',
                    'gram': 'Ej: 250 (gramos)',
                    'liter': 'Ej: 1.5 (un litro y medio)', 
                    'ml': 'Ej: 500 (mililitros)'
                };
                return placeholders[unitCode] || 'Ej: 2.5';
            },
            
            formatCurrency(amount, symbol = 'Bs') {
                return `${symbol} ${parseFloat(amount || 0).toFixed(2)}`;
            },
            
            get total() {
                return this.items.reduce((sum, item) => {
                    const quantity = parseFloat(item.quantity) || 0;
                    const price = parseFloat(item.price_bs) || 0;
                    return sum + (quantity * price);
                }, 0);
            },
            
            async completeSale() {
                if (this.items.length === 0) return;
                
                if (this.isCredit && !this.selectedCustomer) {
                    alert('Debe seleccionar un cliente para ventas a crédito');
                    return;
                }
                
                // Preparar datos de la venta con debugging detallado
                const saleData = {
                    items: this.items.map(item => {
                        const quantity = parseFloat(item.quantity);
                        console.log(`Procesando item: ${item.name}, cantidad original: "${item.quantity}", cantidad parseada: ${quantity}`);
                        
                        return {
                            product_id: item.id,
                            quantity: quantity,
                            price_bs: parseFloat(item.price_bs)
                        };
                    }),
                    customer_id: this.selectedCustomer ? this.selectedCustomer.id : null,
                    is_credit: this.isCredit,
                    notes: this.notes,
                    total_bs: this.total
                };
                
                console.log('=== DATOS DE VENTA COMPLETOS ===');
                console.log(JSON.stringify(saleData, null, 2));
                console.log('=== FIN DATOS DE VENTA ===');
                
                try {
                    const response = await fetch('{% url "sales:create_sale_api" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify(saleData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Error del servidor:', errorData);
                        throw new Error(errorData.error || 'Error al procesar la venta');
                    }
                    
                    const result = await response.json();
                    console.log('Respuesta del servidor:', result);
                    
                    // Abrir recibo en nueva ventana
                    if (result.id) {
                        window.open(`/sales/${result.id}/receipt/`, '_blank');
                        this.resetSale();
                        
                        // Enfocar el input para seguir escaneando
                        setTimeout(() => {
                            document.getElementById('barcode').focus();
                        }, 100);
                    }
                } catch (error) {
                    console.error('Error completo:', error);
                    alert(error.message || 'Error al procesar la venta');
                }
            },
            
            resetSale() {
                this.items = [];
                this.barcode = '';
                this.selectedCustomer = null;
                this.isCredit = false;
                this.notes = '';
                this.closeQuantityModal();
            },
            
            init() {
                // Enfocar el input al cargar la página
                setTimeout(() => {
                    document.getElementById('barcode').focus();
                }, 100);
            }
        }));
    });
</script>
{% endblock %}